/*
 * This Kotlin source file was generated by the Gradle 'init' task.
 */
package tech.skagedal.next

import com.google.api.client.json.jackson2.JacksonFactory
import tech.skagedal.next.configuration.ConfigurationLoader
import tech.skagedal.next.configuration.Task
import tech.skagedal.next.configuration.TasksFile
import tech.skagedal.next.tasks.FileSystemLinter
import tech.skagedal.next.tasks.GmailChecker
import tech.skagedal.next.tasks.IntervalTaskRunner
import java.nio.file.FileSystem
import java.nio.file.FileSystems
import java.nio.file.Files

class App(
    val fileSystem: FileSystem,
    val configurationLoader: ConfigurationLoader,
    val fileSystemLinter: FileSystemLinter,
    val intervalTaskRunner: IntervalTaskRunner,
    val gmailChecker: GmailChecker
) {
    fun run() {
        for (task in readTasks().tasks) {
            when (task) {
                Task.BrewUpgradeTask -> intervalTaskRunner.run()
                Task.FileSystemLintTask -> fileSystemLinter.run()
                is Task.GmailTask -> gmailChecker.run(task.account)
            }
        }
    }

    private fun readTasks(): TasksFile {
        return Files.newBufferedReader(fileSystem.tasksYmlFile()).use { reader ->
            configurationLoader.loadTasks(reader)
        }
    }
}

fun main(args: Array<String>) {
    val processRunner = ProcessRunner()
    val fileSystem = FileSystems.getDefault()
    val taskRecords = TaskRecords(fileSystem)

    val fileSystemLinter = FileSystemLinter(
        fileSystem,
        processRunner
    )
    val intervalTaskRunner = IntervalTaskRunner(
        processRunner,
        taskRecords
    )
    val gmailChecker = GmailChecker(
        fileSystem,
        processRunner,
        JacksonFactory.getDefaultInstance()
    )
    val app = App(fileSystem, ConfigurationLoader(), fileSystemLinter, intervalTaskRunner, gmailChecker)

    app.run()
}
